# =============================================================================
# CD - D√©ploiement sur Hetzner
# D√©clench√© apr√®s merge sur main (si les tests passent)
# =============================================================================

name: CD - Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permet le d√©ploiement manuel

# Emp√™che les d√©ploiements simultan√©s
concurrency:
  group: production
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Tests (doit passer avant d√©ploiement)
  # ===========================================================================
  test:
    name: Run Tests
    uses: ./.github/workflows/ci.yml

  # ===========================================================================
  # D√©ploiement
  # ===========================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: /opt/app
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e

            echo "=== D√©ploiement Sensea ==="
            cd /opt/app

            # 1. Pull des derni√®res modifications
            echo "üì• Pull du code..."
            git fetch origin main
            git reset --hard origin/main

            # 2. Build et red√©marrage des containers
            echo "üê≥ Rebuild des containers..."
            docker compose -f infrastructure/docker-compose.prod.yml build --no-cache frontend api

            # 3. Red√©marrage avec zero-downtime
            echo "üîÑ Red√©marrage des services..."
            docker compose -f infrastructure/docker-compose.prod.yml up -d --remove-orphans

            # 4. Migrations
            echo "üìä Ex√©cution des migrations..."
            docker exec sensea_api php /var/www/html/migrations/migrate.php

            # 5. Nettoyage
            echo "üßπ Nettoyage..."
            docker image prune -f

            # 6. V√©rification sant√©
            echo "üè• V√©rification sant√©..."
            sleep 5

            if ! docker exec sensea_api php -r "echo 'API OK';"; then
              echo "‚ùå API non fonctionnelle"
              exit 1
            fi

            if ! curl -sf http://127.0.0.1:3000 > /dev/null; then
              echo "‚ùå Frontend non fonctionnel"
              exit 1
            fi

            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
          ENDSSH

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check the logs above."

  # ===========================================================================
  # Notification (optionnel - Slack/Discord)
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ D√©ploiement r√©ussi sur production"
          else
            echo "‚ùå √âchec du d√©ploiement"
          fi
